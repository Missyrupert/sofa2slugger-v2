<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sofa2Slugger</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    .session-list {
      max-width: 600px;
      margin: 0 auto;
    }
    .session-item {
      padding: 24px 20px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .session-item:last-child {
      border-bottom: none;
    }
    .session-label {
      font-size: 1.2rem;
      color: #fff;
    }
    button {
      font-size: 1rem;
      padding: 0.75rem 1.5rem;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .play-controls {
      display: flex;
      gap: 10px;
    }
    .stop-button {
      background: #666;
      color: #fff;
    }
    .purchase-section {
      max-width: 600px;
      margin: 20px auto 0;
      padding: 20px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="session-list" id="sessionList"></div>
  <div class="purchase-section" id="purchaseSection"></div>

  <script src="soundscape.js"></script>
  <script>
    const STORAGE_KEYS = {
      SESSION1_COMPLETED: 'session1Completed',
      PURCHASE_UNLOCKED: 'purchaseUnlocked'
    };

    let players = {}; // Track players per session
    let currentPlayingSession = null;

    function getState() {
      return {
        session1Completed: localStorage.getItem(STORAGE_KEYS.SESSION1_COMPLETED) === 'true',
        purchaseUnlocked: localStorage.getItem(STORAGE_KEYS.PURCHASE_UNLOCKED) === 'true'
      };
    }

    function isSessionPlayable(sessionNumber) {
      if (sessionNumber === 1) return true;
      const state = getState();
      return state.purchaseUnlocked;
    }

    function renderPurchaseSection() {
      const state = getState();
      const container = document.getElementById('purchaseSection');
      container.innerHTML = '';

      if (!state.purchaseUnlocked) {
        const purchaseBtn = document.createElement('button');
        purchaseBtn.textContent = 'Purchase';
        purchaseBtn.onclick = () => handlePurchase();
        container.appendChild(purchaseBtn);
      }
    }

    async function handlePurchase() {
      try {
        const confirmed = await initiatePurchase();
        
        if (confirmed) {
          localStorage.setItem(STORAGE_KEYS.PURCHASE_UNLOCKED, 'true');
          renderPurchaseSection();
          renderSessionList();
        }
        // On failure/cancel: silent failure, no action
      } catch (error) {
        // Silent failure, allow manual retry
      }
    }

    async function initiatePurchase() {
      // Redirect to Stripe checkout
      window.location.href = 'https://buy.stripe.com/dRm7sM73Y3E80Unctn8k801';
      // Return false - purchase completion handled by Stripe redirect back
      return false;
    }

    function renderSessionList() {
      const state = getState();
      const container = document.getElementById('sessionList');
      container.innerHTML = '';

      for (let i = 1; i <= 10; i++) {
        const playable = isSessionPlayable(i);
        const sessionItem = document.createElement('div');
        sessionItem.className = 'session-item';
        
        const label = document.createElement('div');
        label.className = 'session-label';
        label.textContent = `Session ${i}`;
        
        const controls = document.createElement('div');
        controls.className = 'play-controls';
        
        if (currentPlayingSession === i) {
          const stopBtn = document.createElement('button');
          stopBtn.className = 'stop-button';
          stopBtn.textContent = 'Stop';
          stopBtn.onclick = () => stopSession(i);
          controls.appendChild(stopBtn);
        } else {
          const playBtn = document.createElement('button');
          playBtn.textContent = 'Play';
          playBtn.disabled = !playable;
          if (playable) {
            playBtn.onclick = () => playSession(i);
          }
          controls.appendChild(playBtn);
        }
        
        sessionItem.appendChild(label);
        sessionItem.appendChild(controls);
        container.appendChild(sessionItem);
      }
    }

    async function playSession(sessionNumber) {
      if (!isSessionPlayable(sessionNumber)) return;
      if (currentPlayingSession !== null) return; // Already playing something
      
      currentPlayingSession = sessionNumber;
      
      const onComplete = () => {
        currentPlayingSession = null;
        renderSessionList();
      };
      
      const player = new SoundscapePlayer(sessionNumber, onComplete);
      await player.init();
      players[sessionNumber] = player;
      
      await player.play();
      renderSessionList();
    }

    function stopSession(sessionNumber) {
      if (players[sessionNumber]) {
        players[sessionNumber].stop();
        delete players[sessionNumber];
      }
      currentPlayingSession = null;
      renderSessionList();
    }

    // Check for successful purchase return from Stripe
    async function checkPurchaseSuccess() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session_id');
      
      if (sessionId) {
        // Clean URL immediately (remove session_id from view)
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Verify session with server
        try {
          const response = await fetch('/.netlify/functions/stripe-verify', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ session_id: sessionId })
          });
          
          const result = await response.json();
          
          if (result.ok === true) {
            // Server verified - unlock sessions
            localStorage.setItem(STORAGE_KEYS.PURCHASE_UNLOCKED, 'true');
            renderPurchaseSection();
            renderSessionList();
          }
          // If verification fails: silent failure, do nothing
        } catch (error) {
          // Network error: silent failure, do nothing
        }
      }
    }

    // Note: Interruption handling (unloading guards, run tokens) is handled in soundscape.js
    // Background audio continues on visibility change (screen lock/tab switch)
    // Unloading guards prevent completion callbacks during navigation

    // Check for purchase success on load
    checkPurchaseSuccess();
    
    // Initial render
    renderPurchaseSection();
    renderSessionList();
  </script>

</body>
</html>
